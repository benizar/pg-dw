
/*
 * SELECT dms.chibo_give_me_pids_by_box(40, 5, 30, -5, 'what_total_pop', 'asc', 10)
 */
CREATE OR REPLACE FUNCTION dms.chibo_give_me_pids_by_box(north numeric, east numeric, south numeric, west numeric, sort_col text default 'what_total_pop', sort_dir text default 'asc' , maxpids integer default 5)
  RETURNS integer[] AS
$BODY$
SELECT array_agg(pid) FROM (SELECT pid
FROM dms.docstore
WHERE ST_Intersects(where_centroid, ST_setSRID(ST_MakeEnvelope(west, south, east, north),4326))

ORDER BY
      -- Simplified to NULL if not sorting in ascending order.
      CASE WHEN sort_dir = 'asc' THEN
          CASE sort_col
              -- Check for each possible value of sort_col.
              WHEN 'what_total_pop' THEN what_total_pop
              --- etc.
              ELSE NULL
          END
      ELSE
          NULL
      END
      ASC,

      -- Same as before, but for sort_dir = 'desc'
      CASE WHEN sort_dir = 'desc' THEN
          CASE sort_col
              WHEN 'what_total_pop' THEN what_total_pop
              ELSE NULL
          END
      ELSE
          NULL
      END
      DESC

    
LIMIT maxpids) AS pids;

$BODY$
  LANGUAGE sql VOLATILE;
